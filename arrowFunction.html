<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1">
  <title>arrowFunction</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.63.1/lib/codemirror.css">
  <script src="https://cdn.jsdelivr.net/npm/codemirror@5.63.1/lib/codemirror.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/codemirror@5.63.1/mode/javascript/javascript.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mocha/9.1.3/mocha.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chai/4.3.4/chai.js"></script>
  <link rel="stylesheet" href="https://wbsckt3.github.io/mocha_test_cases_styles/styles.css">
</head>
<body onload="cargaInicialTestCases()">
<div class="container">
  <div class="explanation">
	<div id="functionNameTitle"></div>
	<div id="explain"></div>
  </div>	
  <div class="code-editor">
	<textarea id="codeEditor" rows="10" cols="50"></textarea>
	<button id="retryButton" style="display: none;" onclick="retryTests()">Reintentar</button>
	<button id="buttonTest2" onclick="openTest()" style="display: none;">Bien hecho! puedes continuar con la siguiente prueba</button>
	<button onclick="runTests()">Run</button>
	<div id="console"></div> 
	<div id="mocha"></div>
	<div id="testResults"></div>
  </div>
</div>
  
  <script>
   
    let currentTestCase; // define ambito global de la variable, hacia arriba y hacia abajo
    let currentTestCaseIndex;
    const testCases = [
		{
			functionName: 'arrowFunction',
			functionExplain: 'Una funci칩n flecha (arrow function)\n\nes una forma m치s concisa de escribir una funci칩n en JavaScript. Se introdujo en ECMAScript 6 como una manera de simplificar la sintaxis de las funciones y de evitar algunos problemas comunes asociados con las funciones normales. En lugar de usar la palabra clave function, las funciones flecha usan una flecha => entre los par칠ntesis de los argumentos y el cuerpo de la funci칩n. Tambi칠n tienen una sintaxis m치s compacta, lo que hace que sea m치s f치cil leer y escribir c칩digo. Aqu칤 hay un ejemplo de una funci칩n flecha que duplica cada elemento en un array: (vamos a manejar las excepciones false, undefined, null, 0, false y Nan)',
			functionResultExplain: 'Bien hecho! 游꿀 puede seguir adelante',
			functionCode: `array => {
			  if (typeof array === 'undefined' || array === null || array.length === 0) {
				return [];
			  } else {
				return array.map(element => element ? element * 2 : element)
			  }
			}
			`,
			tests: [
				{	description: 'Deber칤a retornar el doble de cada elemento en el array',
				assertions: [() => {
				  const input = [1, 2, 3, 4, 5];
				  const expectedResult = [2, 4, 6, 8, 10];
				  assert.deepEqual(testedFunction(input), expectedResult);
				}]
			  },
			  {
				description: 'Deber칤a retornar un array vac칤o cuando se pasa un array vac칤o',
				assertions: [() => {
				  const input = [];
				  const expectedResult = [];
				  assert.deepEqual(testedFunction(input), expectedResult);
				}]
			  },
			  {
				description: 'Deber칤a manejar correctamente los elementos falsy en el array',
				assertions: [() => {
				  const input = [null, undefined, 0, false, NaN];
				  const expectedResult = [null, undefined, 0, false, NaN];
				  assert.deepEqual(testedFunction(input), expectedResult);
				}]
			  }
			]
		}

      // Agrega m치s casos de prueba aqu칤 si es necesario
    ];

     var codeEditor = CodeMirror.fromTextArea(document.getElementById('codeEditor'), {
          lineNumbers: true,
          mode: 'javascript'
        });

    function cargaInicialTestCases() {
      // Cargar la primera funci춷춽n testCase en el CodeMirror al cargar la p치gina
      if (testCases.length > 0) {
        // Obtener el valor de currentTestCaseIndex desde localStorage al cargar la p치gina
        currentTestCaseIndex = localStorage.getItem('currentTestCaseIndex');
        // Si no hay un valor previo en localStorage, inicializarlo en 0
        if (currentTestCaseIndex === null) {
          currentTestCaseIndex = 0;
          localStorage.setItem('currentTestCaseIndex', currentTestCaseIndex);
        }
        const explain = document.getElementById('explain');
		const explain2 = document.getElementById('explain2');
        codeEditor.setValue(testCases[currentTestCaseIndex].functionCode);
        explain.textContent = testCases[currentTestCaseIndex].functionExplain;
		functionNameTitle.textContent = testCases[currentTestCaseIndex].functionName;
      }
    }
   
    const assert = chai.assert; 
	mocha.setup('bdd');

    function openTest() {
      location.reload();
      currentTestCaseIndex = localStorage.getItem("currentTestCaseIndex");
      const codeEditor = document.getElementById('codeEditor');
      const explain = document.getElementById('explain');
      codeEditor.value = testCases[currentTestCaseIndex].functionCode;
      explain.textContent = testCases[currentTestCaseIndex].functionExplain;
      const retryButton = document.getElementById('retryButton');
      retryButton.style.display = 'none';
      const runTestsButton = document.querySelector('button[onclick="runTests()"]');
      runTestsButton.style.display = 'block';
      const buttonTest2 = document.getElementById('buttonTest2');
      buttonTest2.style.display = 'none';
    }

    // Funcion para ejecutar las pruebas
    function runTests() {
    currentTestCaseIndex = localStorage.getItem("currentTestCaseIndex");
    const testCase = testCases[currentTestCaseIndex]; console.log(testCase)
    const userCode = codeEditor.getValue();
    const testName = testCase.functionName; console.log(testName)
    let testedFunction;

    document.getElementById('console').innerHTML = '';
    console.log = function (message) {
        var logMessage = document.createElement('div');
        logMessage.innerHTML = message; // Usar innerHTML en lugar de textContent
        document.getElementById('console').appendChild(logMessage);
    };

    console.originalLog = console.log;

    try {
        // Evaluar y definir la funci칩n en el 치mbito global
        eval(`
                window.testedFunction = ${userCode}
            `);

        console.log("procesando...");
		setTimeout(() => { console.log("Haciendo pruebas...") }, 3000);
        setTimeout(() => { // retrasar la ejecuci칩n de la prueba por 5 segundos
            describe(`Prueba para ${testCase.functionName}`, function () {
                testCase.tests.forEach(test => {
                    it(test.description, function () {
                        try {
                            // Acceder a la funci칩n desde el 치mbito global
                            const userFunction = window.testedFunction;

                            test.assertions.forEach(assertion => {
                                assertion(userFunction); // Pasar la funci칩n como argumento a las assertions
                            });
                        } catch (error) {
                            throw new Error(`La prueba ha fallado: ${error.message}`);
                        }
                    });
                });
            });

            // Ejecutar las pruebas una vez definidas
            const runner = mocha.run();

            // Mostrar los resultados en el elemento 'testResults'
            runner.on('end', function () {
                //const testResults = document.getElementById('testResults');
                //testResults.innerHTML = '';
                const stats = runner.stats;
                const passes = stats.passes;
                const failures = stats.failures;

                if (failures === 0) {
                    console.log("Excelente! 游꿀 haz encontrado los tres errores en la funci칩n! contin칰a con la siguiente prueba");

                    //testResults.innerText = `Pruebas pasadas: ${passes}, Pruebas fallidas: ${failures} ??` ;
                    //testResults.style.backgroundColor = '#4CAF50';
                    const mochastats = document.getElementById('mocha-stats');
                    mochastats.style.backgroundColor = '#4CAF50';
                    // Obtener el objeto 'resultados' del localStorage
                    let resultados = JSON.parse(localStorage.getItem('resultados'));
                    // Verificar si 'resultados' no existe o est치 vac칤o
                    if (!resultados || Object.keys(resultados).length === 0) {
                        // Si no existe o est치 vac칤o, crear un objeto con la primera prueba superada
                        resultados = {
                            [testName]: 'ok'
                        };
                    } else {
                        // Si ya existe, agregar el resultado de la nueva prueba
                        resultados[testName] = 'ok';
                    }
                    // Guardar el objeto 'resultados' en localStorage
                    localStorage.setItem('resultados', JSON.stringify(resultados));
                    currentTestCaseIndex++;
                    localStorage.setItem("currentTestCaseIndex", currentTestCaseIndex);
                    const retryButton = document.getElementById('retryButton');
                    retryButton.style.display = 'none';
                    const runTestsButton = document.querySelector('button[onclick="runTests()"]');
                    runTestsButton.style.display = 'none';
                    if (testCases.length > currentTestCaseIndex) {
                        const buttonTest2 = document.getElementById('buttonTest2');
                        buttonTest2.style.display = 'block';
                        buttonTest2.textContent = testCases[currentTestCaseIndex - 1].functionResultExplain;
                    } else {
                        alert('pruebas terminadas')
                    }


                } else {
                    console.log("Ejemplo de la ejecuci칩n esperada:");
                    console.log("Pista: en la funci칩n hay 3 errores");

                    //testResults.innerText = `Pruebas pasadas: ${passes}, Pruebas fallidas: ${failures}`;
                    //testResults.style.backgroundColor = '#FFC107';
                    //testResults.style.color = 'black';
                    const mochastats = document.getElementById('mocha-stats');
                    mochastats.style.backgroundColor = 'rgb(244, 207, 94)';
                    const runTestsButton = document.querySelector('button[onclick="runTests()"]');
                    runTestsButton.style.display = 'none';
                    const retryButton = document.getElementById('retryButton');
                    retryButton.style.display = 'block';
                }

            });

            // }); // end foreach testCase
        }, 5000); // esperar 5 segundos
    } catch (error) {
        const testResults = document.getElementById('testResults');
        testResults.innerText = `Error al ejecutar las pruebas: ${error}`;
    }
}

    function retryTests() {
      location.reload();
    }
	
  </script>
</body>
</html>  
